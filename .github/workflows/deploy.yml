name: Deploy Vite to hoster.by (SFTP) via pnpm

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - name: Verify posts index is up to date
        run: |
          node scripts/generate-posts-index.mjs
          git diff --exit-code src/posts/posts-index.json
      - run: pnpm run build
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          SITE_BASE: ${{ secrets.SITE_BASE }}
          VITE_SITE_URL: ${{ secrets.SITE_URL }}

      - name: Load HOSTERBY secret into env
        run: |
          echo "${{ secrets.HOSTERBY }}" >> $GITHUB_ENV

      - name: Check loaded vars (masked)
        run: |
          if [ -z "$SSH_HOST" ]; then echo "SSH_HOST EMPTY"; else echo "SSH_HOST set"; fi
          if [ -z "$SSH_PORT" ]; then echo "SSH_PORT EMPTY"; else echo "SSH_PORT set"; fi
          if [ -z "$SSH_USER" ]; then echo "SSH_USER EMPTY"; else echo "SSH_USER set"; fi
          if [ -z "$SSH_PASSWORD" ]; then echo "SSH_PASSWORD EMPTY"; else echo "SSH_PASSWORD set"; fi
          if [ -z "$SSH_TARGET" ]; then echo "SSH_TARGET EMPTY"; else echo "SSH_TARGET set"; fi

      - name: Upload dist via SFTP (SSH debug)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          source: "dist/*"
          target: ${{ env.SSH_TARGET }}
          strip_components: 1
          overwrite: true
          debug: true
